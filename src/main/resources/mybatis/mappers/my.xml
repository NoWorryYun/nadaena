<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="my">
 
	<!-- 참가챌린지 가져오기 -->
	<select id="selectList" resultType="MyVo">
		<![CDATA[
			select  m.userNo,
					m.userClgNo,
					c.challengeNo,
					c.clgTitle,
					m.mychallengeDate,
					m.founder,
					m.achievement,
					m.state,
			        to_char(c.regdate, 'yy/mm/dd') regDate,
			        c.recruitment,
			        c.period,
			        c.clgGroup,
			        to_char(c.regdate + c.recruitment) startday,
			        to_char(c.regdate + c.recruitment + c.period) endday,
			        m.payment,
			        to_char(sysdate-1, 'yy/mm/dd') yesterday,
			        c.clglevel
			from challenge c, mychallenge m
			where c.challengeNo = m.challengeNo
			and   m.state = 1
			and   c.clgGroup=1
		]]>
	</select>	
	
	<!-- 종료 챌린지(전체) + 페이징 -->
	<select id="selectList12" parameterType= "Map" resultType="MyVo">
		<![CDATA[
			select  ort.rn,
					ort.userNo,
					ort.userClgNo,
					ort.challengeNo,
					ort.clgTitle,
					ort.mychallengeDate,
					ort.founder,
					ort.achievement,
					ort.state,
			        ort.regDate,
			        ort.recruitment,
			        ort.period,
			        ort.clgGroup,
			        ort.startday,
			        ort.endday,
			        ort.payment,
			        ort.yesterday,
			        ort.clglevel
			from (select rownum rn,
						 ot.userNo,
						 ot.userClgNo,
						 ot.challengeNo,
						 ot.clgTitle,
						 ot.mychallengeDate,
						 ot.founder,
						 ot.achievement,
						 ot.state,
			        	 ot.regDate,
			        	 ot.recruitment,
			        	 ot.period,
			        	 ot.clgGroup,
			        	 ot.startday,
			        	 ot.endday,
			       	  	 ot.payment,
			       	  	 ot.yesterday,
			       	  	 ot.clglevel
				  from (select  m.userNo,
								m.userClgNo,
								c.challengeNo,
								c.clgTitle,
								m.mychallengeDate,
								m.founder,
								m.achievement,
								m.state,
						        to_char(c.regdate, 'yy/mm/dd') regDate,
						        c.recruitment,
						        c.period,
						        c.clgGroup,
						        to_char(c.regdate + c.recruitment) startday,
						        to_char(c.regdate + c.recruitment + c.period) endday,
						        m.payment,
						        to_char(sysdate-1, 'yy/mm/dd') yesterday,
						        c.clglevel
					    from challenge c, mychallenge m
					    where c.challengeNo = m.challengeNo
					    and   m.state = 2
					    and   c.clgGroup=1)ot
				  )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  
		]]>
	</select>
	
	<!-- 종료 챌린지(전체) + 페이징 -->
	<select id="selectList13" parameterType= "Map" resultType="MyVo">
		<![CDATA[
			select  ort.rn,
					ort.userNo,
					ort.userClgNo,
					ort.challengeNo,
					ort.clgTitle,
					ort.mychallengeDate,
					ort.founder,
					ort.achievement,
					ort.state,
			        ort.regDate,
			        ort.recruitment,
			        ort.period,
			        ort.clgGroup,
			        ort.startday,
			        ort.endday,
			        ort.payment,
			        ort.yesterday,
			        ort.clglevel
			from (select rownum rn,
						 ot.userNo,
						 ot.userClgNo,
						 ot.challengeNo,
						 ot.clgTitle,
						 ot.mychallengeDate,
						 ot.founder,
						 ot.achievement,
						 ot.state,
			        	 ot.regDate,
			        	 ot.recruitment,
			        	 ot.period,
			        	 ot.clgGroup,
			        	 ot.startday,
			        	 ot.endday,
			       	  	 ot.payment,
			       	  	 ot.yesterday,
			       	  	 ot.clglevel
				  from (select  m.userNo,
								m.userClgNo,
								c.challengeNo,
								c.clgTitle,
								m.mychallengeDate,
								m.founder,
								m.achievement,
								m.state,
						        to_char(c.regdate, 'yy/mm/dd') regDate,
						        c.recruitment,
						        c.period,
						        c.clgGroup,
						        to_char(c.regdate + c.recruitment) startday,
						        to_char(c.regdate + c.recruitment + c.period) endday,
						        m.payment,
						        to_char(sysdate-1, 'yy/mm/dd') yesterday,
						        c.clglevel
					    from challenge c, mychallenge m
					    where c.challengeNo = m.challengeNo
					    and   m.state = 2
					    and   m.achievement >= 90
					    and   c.clgGroup=1)ot
				  )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  
		]]>
	</select>	
	
	
	<!-- 종료 챌린지(실패) + 페이징 -->
	<select id="selectList14" parameterType= "Map" resultType="MyVo">
		<![CDATA[
			select  ort.rn,
					ort.userNo,
					ort.userClgNo,
					ort.challengeNo,
					ort.clgTitle,
					ort.mychallengeDate,
					ort.founder,
					ort.achievement,
					ort.state,
			        ort.regDate,
			        ort.recruitment,
			        ort.period,
			        ort.clgGroup,
			        ort.startday,
			        ort.endday,
			        ort.payment,
			        ort.yesterday,
			        ort.clglevel
			from (select rownum rn,
						 ot.userNo,
						 ot.userClgNo,
						 ot.challengeNo,
						 ot.clgTitle,
						 ot.mychallengeDate,
						 ot.founder,
						 ot.achievement,
						 ot.state,
			        	 ot.regDate,
			        	 ot.recruitment,
			        	 ot.period,
			        	 ot.clgGroup,
			        	 ot.startday,
			        	 ot.endday,
			       	  	 ot.payment,
			       	  	 ot.yesterday,
			       	  	 ot.clglevel
				  from (select  m.userNo,
								m.userClgNo,
								c.challengeNo,
								c.clgTitle,
								m.mychallengeDate,
								m.founder,
								m.achievement,
								m.state,
						        to_char(c.regdate, 'yy/mm/dd') regDate,
						        c.recruitment,
						        c.period,
						        c.clgGroup,
						        to_char(c.regdate + c.recruitment) startday,
						        to_char(c.regdate + c.recruitment + c.period) endday,
						        m.payment,
						        to_char(sysdate-1, 'yy/mm/dd') yesterday,
						        c.clglevel
					    from challenge c, mychallenge m
					    where c.challengeNo = m.challengeNo
					    and   m.state = 2
					    and   m.achievement < 90
					    and   c.clgGroup=1)ot
				  )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  
		]]>
	</select>	
	
	<!-- 진행 이벤트(전체) + 페이징 -->
	<select id="selectList21" parameterType= "Map" resultType="MyVo">
		<![CDATA[
			select  ort.rn,
					ort.userNo,
					ort.userClgNo,
					ort.challengeNo,
					ort.clgTitle,
					ort.mychallengeDate,
					ort.founder,
					ort.achievement,
					ort.state,
			        ort.regDate,
			        ort.recruitment,
			        ort.period,
			        ort.clgGroup,
			        ort.startday,
			        ort.endday,
			        ort.payment,
			        ort.yesterday,
			        ort.clglevel
			from (select rownum rn,
						 ot.userNo,
						 ot.userClgNo,
						 ot.challengeNo,
						 ot.clgTitle,
						 ot.mychallengeDate,
						 ot.founder,
						 ot.achievement,
						 ot.state,
			        	 ot.regDate,
			        	 ot.recruitment,
			        	 ot.period,
			        	 ot.clgGroup,
			        	 ot.startday,
			        	 ot.endday,
			       	  	 ot.payment,
			       	  	 ot.yesterday,
			       	  	 ot.clglevel
				  from (select  m.userNo,
								m.userClgNo,
								c.challengeNo,
								c.clgTitle,
								m.mychallengeDate,
								m.founder,
								m.achievement,
								m.state,
						        to_char(c.regdate, 'yy/mm/dd') regDate,
						        c.recruitment,
						        c.period,
						        c.clgGroup,
						        to_char(c.regdate + c.recruitment) startday,
						        to_char(c.regdate + c.recruitment + c.period) endday,
						        m.payment,
						        to_char(sysdate-1, 'yy/mm/dd') yesterday,
						        c.clglevel
					    from challenge c, mychallenge m
					    where c.challengeNo = m.challengeNo
					    and   m.state = 1
					    and   c.clgGroup=2)ot
				  )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  
		]]>
	</select>
	<!-- 종료 이벤트(전체) + 페이징 -->
	<select id="selectList22" parameterType= "Map" resultType="MyVo">
		<![CDATA[
			select  ort.rn,
					ort.userNo,
					ort.userClgNo,
					ort.challengeNo,
					ort.clgTitle,
					ort.mychallengeDate,
					ort.founder,
					ort.achievement,
					ort.state,
			        ort.regDate,
			        ort.recruitment,
			        ort.period,
			        ort.clgGroup,
			        ort.startday,
			        ort.endday,
			        ort.payment,
			        ort.yesterday,
			        ort.clglevel
			from (select rownum rn,
						 ot.userNo,
						 ot.userClgNo,
						 ot.challengeNo,
						 ot.clgTitle,
						 ot.mychallengeDate,
						 ot.founder,
						 ot.achievement,
						 ot.state,
			        	 ot.regDate,
			        	 ot.recruitment,
			        	 ot.period,
			        	 ot.clgGroup,
			        	 ot.startday,
			        	 ot.endday,
			       	  	 ot.payment,
			       	  	 ot.yesterday,
			       	  	 ot.clglevel
				  from (select  m.userNo,
								m.userClgNo,
								c.challengeNo,
								c.clgTitle,
								m.mychallengeDate,
								m.founder,
								m.achievement,
								m.state,
						        to_char(c.regdate, 'yy/mm/dd') regDate,
						        c.recruitment,
						        c.period,
						        c.clgGroup,
						        to_char(c.regdate + c.recruitment) startday,
						        to_char(c.regdate + c.recruitment + c.period) endday,
						        m.payment,
						        to_char(sysdate-1, 'yy/mm/dd') yesterday,
						        c.clglevel
					    from challenge c, mychallenge m
					    where c.challengeNo = m.challengeNo
					    and   m.state = 2
					    and   c.clgGroup=2)ot
				  )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  
		]]>
	</select>	
	
	<!-- 전체글갯수 구하기 -->
	<select id="selectTotalCnt" resultType="int">
		<![CDATA[
			select count(*) count
			from challenge c, mychallenge m
		    where c.challengeNo = m.challengeNo
		    and m.state=2
		    and   c.clgGroup=1
		]]>
	</select>
	
	<!-- 성공글갯수 구하기 -->
	<select id="selectTotalCnt2" resultType="int">
		<![CDATA[
			select count(*) count
			from challenge c, mychallenge m
		    where c.challengeNo = m.challengeNo
		    and m.achievement >= 90
		    and m.state=2
		    and   c.clgGroup=1
		]]>
	</select>	

	<!-- 실패글갯수 구하기 -->
	<select id="selectTotalCnt3" resultType="int">
		<![CDATA[
			select count(*) count
			from challenge c, mychallenge m
		    where c.challengeNo = m.challengeNo
		    and m.achievement < 90
		    and m.state=2
		    and   c.clgGroup=1
		]]>
	</select>


	<!-- 이벤트 진행중 갯수 구하기 -->
	<select id="selectTotalCnt21" resultType="int">
		<![CDATA[
			select count(*) count
			from challenge c, mychallenge m
		    where c.challengeNo = m.challengeNo
		    and m.state=1
		    and   c.clgGroup=2
		]]>
	</select>	
	
	<!-- 종료 이벤트 갯수 구하기 -->
	<select id="selectTotalCnt22" resultType="int">
		<![CDATA[
			select count(*) count
			from challenge c, mychallenge m
		    where c.challengeNo = m.challengeNo
		    and m.state=2
		    and   c.clgGroup=2
		]]>
	</select>	
	
	<!-- 북마크 챌린지 리스트 페이징 -->	
	<select id="selectbList1" parameterType= "Map" resultType="MyVo">
		<![CDATA[
			select  ort.rn,
					ort.bookmarkNo,
					ort.userNo,
					ort.challengeNo,
					ort.bookmarkDate,
					ort.clgTitle,
					ort.Img,
			        ort.regDate,
			        ort.recruitment,
			        ort.period,
			        ort.clgGroup,
			        ort.startday,
			        ort.endday,
			        ort.yesterday,
			        ort.clglevel
			from (select rownum rn,
						 ot.bookmarkNo,
						 ot.userNo,
						 ot.challengeNo,
						 ot.bookmarkDate,
						 ot.clgTitle,
						 ot.Img,
				         ot.regDate,
				         ot.recruitment,
				         ot.period,
				         ot.clgGroup,
				         ot.startday,
				         ot.endday,
				         ot.yesterday,
				         ot.clglevel
				  from (select  b.bookmarkNo,
								b.userNo,
								c.challengeNo,
								to_char(b.bookmarkDate, 'yy/mm/dd') bookmarkDate,
								c.clgTitle,
								c.Img,
						        to_char(c.regdate, 'yy/mm/dd') regDate,
						        c.recruitment,
						        c.period,
						        c.clgGroup,
						        to_char(c.regdate + c.recruitment) startday,
						        to_char(c.regdate + c.recruitment + c.period) endday,
						        to_char(sysdate-1, 'yy/mm/dd') yesterday,
						        c.clglevel					
						from bookmark b, users u, challenge c
						where b.bookmarkno = c.challengeNo
						and b.userno = u.userno
						and c.clgGroup = 1)ot
						)ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  		
		]]>
	</select>	
	
	<!-- 북마크 이벤트 리스트 페이징 -->
	<select id="selectbList2" parameterType= "Map" resultType="MyVo">
		<![CDATA[
			select  ort.rn,
					ort.bookmarkNo,
					ort.userNo,
					ort.challengeNo,
					ort.bookmarkDate,
					ort.clgTitle,
					ort.Img,
			        ort.regDate,
			        ort.recruitment,
			        ort.period,
			        ort.clgGroup,
			        ort.startday,
			        ort.endday,
			        ort.yesterday,
			        ort.clglevel
			from (select rownum rn,
						 ot.bookmarkNo,
						 ot.userNo,
						 ot.challengeNo,
						 ot.bookmarkDate,
						 ot.clgTitle,
						 ot.Img,
				         ot.regDate,
				         ot.recruitment,
				         ot.period,
				         ot.clgGroup,
				         ot.startday,
				         ot.endday,
				         ot.yesterday,
				         ot.clglevel
				  from (select  b.bookmarkNo,
								b.userNo,
								c.challengeNo,
								to_char(b.bookmarkDate, 'yy/mm/dd') bookmarkDate,
								c.clgTitle,
								c.Img,
						        to_char(c.regdate, 'yy/mm/dd') regDate,
						        c.recruitment,
						        c.period,
						        c.clgGroup,
						        to_char(c.regdate + c.recruitment) startday,
						        to_char(c.regdate + c.recruitment + c.period) endday,
						        to_char(sysdate-1, 'yy/mm/dd') yesterday,
						        c.clglevel					
						from bookmark b, users u, challenge c
						where b.bookmarkno = c.challengeNo
						and b.userno = u.userno
						and c.clgGroup = 2)ot
						)ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}
		]]>
	</select>	
	
	<!-- 북마크 챌린지 갯수-->
	<select id="selectTotalCntb1" resultType="int">
		<![CDATA[
			select  count(*) count
			from bookmark b, users u, challenge c
			where b.bookmarkno = c.challengeNo
			and b.userno = u.userno
			and c.clgGroup = 1
		]]>
	</select>	
	
	<!-- 북마크 이벤트 갯수-->
	<select id="selectTotalCntb2" resultType="int">
		<![CDATA[
			select  count(*) count
			from bookmark b, users u, challenge c
			where b.bookmarkno = c.challengeNo
			and b.userno = u.userno
			and c.clgGroup = 2
		]]>
	</select>	
	
	<!-- 리뷰불러오기 + 페이징 -->
	<select id="selectreviewList" parameterType= "Map" resultType="ReviewVo">
		<![CDATA[
			select  ort.rn,
					ort.reviewNo,
					ort.challengeNo,
					ort.userNo,
					ort.reviewContent,
					ort.reviewImg,
					ort.nickname,
					ort.reviewDate
			from (select rownum rn,
						 ot.reviewNo,
						 ot.challengeNo,
						 ot.userNo,
						 ot.reviewContent,
						 ot.reviewImg,
						 ot.nickname,
						 ot.reviewDate
				  from (select  reviewNo,
								challengeNo,
								u.userNo,
								reviewContent,
								reviewImg,
								u.nickname,
								r.reviewDate
						from review r, users u
						where u.userNo = r.userNo
						and u.userno = 1)ot
				  )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  
		]]>
	</select>	

	<!-- 챌린지 리뷰 리스트 -->
	<select id="selectreview" parameterType= "Map" resultType="ReviewVo">
		<![CDATA[
			select  ort.rn,
					ort.reviewNo,
					ort.challengeNo,
					ort.userNo,
					ort.reviewContent,
					ort.reviewImg,
					ort.nickname,
					ort.clgTitle,
					ort.reviewDate
			from (select rownum rn,
						 ot.reviewNo,
						 ot.challengeNo,
						 ot.userNo,
						 ot.reviewContent,
						 ot.reviewImg,
						 ot.nickname,
						 ot.clgTitle,
						 ot.reviewDate
				  from (select  r.reviewNo,
						        r.challengeNo,
						        u.userNo,
						        r.reviewContent,
						        r.reviewImg,
						        u.nickname,
						        c.clgTitle,
						        r.reviewDate
						from review r, challenge c, users u
						where r.challengeno = c.challengeno
						and r.userno = u.userno
						and c.challengeno = #{challengeNo})ot
				  )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  
		]]>
	</select>	
	
	<!-- 마이리뷰 갯수 구하기 -->
	<select id="selectTotalCnt41" resultType="int">
		<![CDATA[
			select count(*) count
			from review r, users u
		    where u.userNo = r.userNo
		    and u.userNo=1
		]]>
	</select>		

	<!-- 챌린지리뷰 갯수 구하기 -->
	<select id="selectTotalrCnt" resultType="int">
		<![CDATA[
			select count(*) count
		    from review r, challenge c, users u
			where r.challengeno = c.challengeno
			and r.userno = u.userno
			and c.challengeno = #{challengeNo}
		]]>
	</select>
		
	<!-- 리뷰작성 -->
	<insert id="insertReview" parameterType="ReviewVo">
		<![CDATA[
			insert into review
			values (SEQ_REVIEWNO.nextval,
					#{challengeNo},
					#{userNo},
					#{reviewImg},
					#{reviewContent},
					sysdate
					)
		]]>
	</insert>
	
	<!-- 리뷰 작성시 상태 업데이트 -->
	<update id="updateState" parameterType="ReviewVo">
		<![CDATA[
			update myChallenge
			set state = 2
			where challengeNo = #{challengeNo}
			and userNo = #{userNo}
		]]>
	</update>
	
	<!-- 내가 쓴 리뷰 삭제 -->
	<delete id="deleteReview" parameterType="ReviewVo">
		<![CDATA[
			delete from review 
			where reviewNo = #{reviewNo}
		]]>
	</delete>
	
	<!-- 리워드 관련 정보 가져오기 -->
	<select id="selectReviewPoint" parameterType ="ReviewVo" resultType="ReviewVo">
		<![CDATA[	
			select  c.challengeNo,
			        m.userNo,
			        c.clgLevel,  
			        m.payment
			from challenge c, mychallenge m
			where c.challengeNo = m.challengeNo
			and c.challengeNo = #{challengeNo}
			and m.userNo = #{userNo}
		]]>
	</select>	
	
	<!-- 리뷰 작성시 리워드 지급-->
	<insert id="insertReviewPoint" parameterType="ReviewVo">
		<![CDATA[
			insert into point
			values (SEQ_pointNo.nextval,
					#{userNo},
					3,
					0,
					#{amount},
					sysdate,
					#{challengeSource},
					null,
					null
					)
		]]>
	</insert>	
	
	<!-- 포인트내역 + 페이징 -->
	<select id="selectPoint" parameterType= "Map" resultType="ReviewVo">
		<![CDATA[
			select  ort.rn,
					ort.pointNo,
					ort.userNo,
					ort.pointGroup,
					ort.charge,
					ort.amount,
					ort.pointDate,
					ort.challengeSource,
					ort.productSource,
					ort.pointMemo
			from (select rownum rn,
						 ot.pointNo,
						 ot.userNo,
						 ot.pointGroup,
						 ot.charge,
						 ot.amount,
						 ot.pointDate,
						 ot.challengeSource,
						 ot.productSource,
						 ot.pointMemo
				  from (select  p.pointNo,
								p.userNo,
								p.pointGroup,
								p.charge,
								p.amount,
								p.pointDate,
								p.challengeSource,
								p.productSource,
								p.pointMemo
						from users u, point p
						where u.userNo = p.userNo
						order by p.pointDate desc)ot
				  )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}	  
		]]>
	</select>	
	
	<!-- 포인트총합 -->
	<select id="selectSum" resultType="int">
		<![CDATA[	
			select  sum(amount) sum
			from point
			where userNo=1
		]]>
	</select>	
	
	
	<!-- 포인트내역 갯수 구하기 -->
	<select id="selectTotalCnt51" resultType="int">
		<![CDATA[
			select count(*) count
			from point p, users u
		    where u.userNo = p.userNo
		]]>
	</select>	
	
</mapper>